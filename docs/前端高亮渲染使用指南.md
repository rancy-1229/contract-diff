# 前端高亮渲染使用指南

## 概述

前端高亮渲染功能允许用户在前端直接渲染PDF文档并显示差异高亮，无需后端预生成带高亮的图片。这提供了更好的交互体验和性能。

## 功能特性

### ✅ 已实现功能

1. **PDF.js集成**: 使用PDF.js在前端直接渲染PDF文档
2. **Canvas高亮绘制**: 使用Canvas API绘制差异高亮色块
3. **坐标转换系统**: 精确的PDF坐标到Canvas坐标转换
4. **交互功能**: 支持点击高亮、悬停效果、缩放操作
5. **多页支持**: 支持多页PDF文档的翻页和差异显示
6. **向后兼容**: 保留传统图片模式，支持渐进式迁移

### 🚀 技术优势

- **实时渲染**: 无需等待后端图片生成
- **动态交互**: 支持实时调整高亮样式
- **内存效率**: 不存储大量图片文件
- **网络优化**: 减少图片传输量
- **流畅体验**: 60fps的渲染性能

## 组件架构

### 核心组件

1. **PDFViewer**: PDF.js集成组件，负责PDF渲染和基础交互
2. **HighlightRenderer**: Canvas高亮绘制组件，负责差异高亮显示
3. **PDFHighlightViewer**: 集成组件，组合PDF渲染和高亮功能
4. **ComparisonDisplayWithPDF**: 完整的对比显示组件，支持PDF和图片模式切换

### 组件关系

```
ComparisonDisplayWithPDF
├── PDFHighlightViewer
│   ├── PDFViewer (PDF.js渲染)
│   └── HighlightRenderer (Canvas高亮)
└── DiffSidebar (差异列表)
```

## 使用方法

### 1. 基础使用

```tsx
import PDFHighlightViewer from '../components/PDFHighlightViewer';

<PDFHighlightViewer
  pdfUrl="/api/documents/123/pdf"
  diffList={diffList}
  currentPage={0}
  onPageChange={(page) => setCurrentPage(page)}
  onDiffClick={(diff) => handleDiffClick(diff)}
/>
```

### 2. 完整对比显示

```tsx
import ComparisonDisplayWithPDF from '../components/ComparisonDisplayWithPDF';

<ComparisonDisplayWithPDF
  comparisonData={{
    comparison_id: "123",
    standard_pdf_url: "/api/documents/123/pdf",
    target_pdf_url: "/api/documents/456/pdf",
    diff_list: diffList,
    summary: summary,
    ai_review_enabled: true
  }}
  aiReviews={aiReviews}
  aiReviewStatus="completed"
  onRefreshAiReviews={handleRefresh}
/>
```

### 3. 模式切换

```tsx
const [usePDFViewer, setUsePDFViewer] = useState(true);

// 在ComparisonDisplayWithPDF中自动支持模式切换
// 通过浮动按钮或设置进行切换
```

## API接口

### 后端API变更

#### 对比结果API响应

```typescript
interface ComparisonResponse {
  comparison_id: string;
  // 新增PDF URL字段
  standard_pdf_url?: string;
  target_pdf_url?: string;
  page_count?: number;
  // 保留向后兼容
  standard_images: string[];
  target_images: string[];
  diff_list: DiffItem[];
  summary: Summary;
  ai_review_enabled?: boolean;
}
```

#### PDF文件下载API

```http
GET /api/documents/{document_id}/pdf
```

返回原始PDF文件，支持浏览器直接显示。

### 前端类型定义

```typescript
interface DiffItem {
  element_id: string;
  status: 'ADD' | 'DELETE' | 'MODIFY' | 'MOVE';
  page_index: number;
  old_text?: string;
  new_text?: string;
  
  // 坐标信息
  diff: Array<Array<{
    text: string;
    page_index: number;
    char_polygons: number[][];
    // ... 其他坐标信息
  }>>;
}
```

## 配置选项

### PDF.js配置

```typescript
// 在PDFViewer组件中
pdfjsLib.GlobalWorkerOptions.workerSrc = 
  `//cdnjs.cloudflare.com/ajax/libs/pdf.js/${pdfjsLib.version}/pdf.worker.min.js`;
```

### 高亮样式配置

```typescript
const DIFF_STYLES = {
  ADD: { color: '#52c41a', opacity: 0.3 },
  DELETE: { color: '#ff4d4f', opacity: 0.3 },
  MODIFY: { color: '#faad14', opacity: 0.3 },
  MOVE: { color: '#1890ff', opacity: 0.3 }
};
```

## 性能优化

### 1. 虚拟化渲染

```typescript
// 只渲染可见页面的高亮
const pageDiffs = diffList.filter(diff => diff.page_index === currentPage);
```

### 2. Canvas优化

```typescript
// 使用requestAnimationFrame优化渲染
const renderHighlights = useCallback(() => {
  requestAnimationFrame(() => {
    // 渲染逻辑
  });
}, [dependencies]);
```

### 3. 内存管理

```typescript
// 及时清理Canvas上下文
useEffect(() => {
  return () => {
    if (canvasRef.current) {
      const ctx = canvasRef.current.getContext('2d');
      ctx?.clearRect(0, 0, canvas.width, canvas.height);
    }
  };
}, []);
```

## 浏览器兼容性

### 支持的浏览器

- Chrome 60+
- Firefox 55+
- Safari 12+
- Edge 79+

### 依赖要求

- Canvas 2D API支持
- PDF.js兼容性
- ES6+支持

## 故障排除

### 常见问题

1. **PDF加载失败**
   - 检查PDF文件URL是否正确
   - 确认后端PDF文件存在
   - 检查CORS设置

2. **高亮不显示**
   - 检查差异数据格式
   - 确认坐标信息正确
   - 检查Canvas尺寸设置

3. **性能问题**
   - 减少同时渲染的差异数量
   - 使用虚拟化渲染
   - 优化Canvas绘制逻辑

### 调试工具

```typescript
// 启用调试日志
console.log('[PDFViewer] PDF加载成功');
console.log('[HighlightRenderer] 渲染了 X 个高亮');
```

## 迁移指南

### 从图片模式迁移

1. **渐进式迁移**
   ```typescript
   // 支持两种模式
   const usePDFViewer = featureFlags.enablePDFViewer;
   ```

2. **A/B测试**
   ```typescript
   // 根据用户分组选择模式
   const usePDFViewer = userGroup === 'pdf-viewer';
   ```

3. **回滚机制**
   ```typescript
   // 保留图片模式作为降级方案
   if (pdfLoadError) {
     setUsePDFViewer(false);
   }
   ```

## 测试

### 单元测试

```typescript
// 测试坐标转换
test('PDF坐标转Canvas坐标', () => {
  const result = CoordinateTransformer.pdfToCanvas(
    [100, 100, 200, 200],
    612, 792, 800, 600, 1.0
  );
  expect(result).toEqual([130, 126, 261, 253]);
});
```

### 集成测试

```typescript
// 测试PDF加载和高亮显示
test('PDF高亮渲染', async () => {
  render(<PDFHighlightViewer {...props} />);
  await waitFor(() => {
    expect(screen.getByText('差异被点击')).toBeInTheDocument();
  });
});
```

## 未来规划

### 短期目标

- [ ] 性能优化和内存管理
- [ ] 更多交互功能（缩放、旋转）
- [ ] 移动端适配

### 长期目标

- [ ] 3D高亮效果
- [ ] 实时协作功能
- [ ] 离线支持

---

*最后更新: 2025-09-24*
