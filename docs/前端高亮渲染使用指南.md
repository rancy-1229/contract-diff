# å‰ç«¯é«˜äº®æ¸²æŸ“ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

å‰ç«¯é«˜äº®æ¸²æŸ“åŠŸèƒ½å…è®¸ç”¨æˆ·åœ¨å‰ç«¯ç›´æ¥æ¸²æŸ“PDFæ–‡æ¡£å¹¶æ˜¾ç¤ºå·®å¼‚é«˜äº®ï¼Œæ— éœ€åç«¯é¢„ç”Ÿæˆå¸¦é«˜äº®çš„å›¾ç‰‡ã€‚è¿™æä¾›äº†æ›´å¥½çš„äº¤äº’ä½“éªŒå’Œæ€§èƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

### âœ… å·²å®ç°åŠŸèƒ½

1. **PDF.jsé›†æˆ**: ä½¿ç”¨PDF.jsåœ¨å‰ç«¯ç›´æ¥æ¸²æŸ“PDFæ–‡æ¡£
2. **Canvasé«˜äº®ç»˜åˆ¶**: ä½¿ç”¨Canvas APIç»˜åˆ¶å·®å¼‚é«˜äº®è‰²å—
3. **åæ ‡è½¬æ¢ç³»ç»Ÿ**: ç²¾ç¡®çš„PDFåæ ‡åˆ°Canvasåæ ‡è½¬æ¢
4. **äº¤äº’åŠŸèƒ½**: æ”¯æŒç‚¹å‡»é«˜äº®ã€æ‚¬åœæ•ˆæœã€ç¼©æ”¾æ“ä½œ
5. **å¤šé¡µæ”¯æŒ**: æ”¯æŒå¤šé¡µPDFæ–‡æ¡£çš„ç¿»é¡µå’Œå·®å¼‚æ˜¾ç¤º
6. **å‘åå…¼å®¹**: ä¿ç•™ä¼ ç»Ÿå›¾ç‰‡æ¨¡å¼ï¼Œæ”¯æŒæ¸è¿›å¼è¿ç§»

### ğŸš€ æŠ€æœ¯ä¼˜åŠ¿

- **å®æ—¶æ¸²æŸ“**: æ— éœ€ç­‰å¾…åç«¯å›¾ç‰‡ç”Ÿæˆ
- **åŠ¨æ€äº¤äº’**: æ”¯æŒå®æ—¶è°ƒæ•´é«˜äº®æ ·å¼
- **å†…å­˜æ•ˆç‡**: ä¸å­˜å‚¨å¤§é‡å›¾ç‰‡æ–‡ä»¶
- **ç½‘ç»œä¼˜åŒ–**: å‡å°‘å›¾ç‰‡ä¼ è¾“é‡
- **æµç•…ä½“éªŒ**: 60fpsçš„æ¸²æŸ“æ€§èƒ½

## ç»„ä»¶æ¶æ„

### æ ¸å¿ƒç»„ä»¶

1. **PDFViewer**: PDF.jsé›†æˆç»„ä»¶ï¼Œè´Ÿè´£PDFæ¸²æŸ“å’ŒåŸºç¡€äº¤äº’
2. **HighlightRenderer**: Canvasé«˜äº®ç»˜åˆ¶ç»„ä»¶ï¼Œè´Ÿè´£å·®å¼‚é«˜äº®æ˜¾ç¤º
3. **PDFHighlightViewer**: é›†æˆç»„ä»¶ï¼Œç»„åˆPDFæ¸²æŸ“å’Œé«˜äº®åŠŸèƒ½
4. **ComparisonDisplayWithPDF**: å®Œæ•´çš„å¯¹æ¯”æ˜¾ç¤ºç»„ä»¶ï¼Œæ”¯æŒPDFå’Œå›¾ç‰‡æ¨¡å¼åˆ‡æ¢

### ç»„ä»¶å…³ç³»

```
ComparisonDisplayWithPDF
â”œâ”€â”€ PDFHighlightViewer
â”‚   â”œâ”€â”€ PDFViewer (PDF.jsæ¸²æŸ“)
â”‚   â””â”€â”€ HighlightRenderer (Canvasé«˜äº®)
â””â”€â”€ DiffSidebar (å·®å¼‚åˆ—è¡¨)
```

## ä½¿ç”¨æ–¹æ³•

### 1. åŸºç¡€ä½¿ç”¨

```tsx
import PDFHighlightViewer from '../components/PDFHighlightViewer';

<PDFHighlightViewer
  pdfUrl="/api/documents/123/pdf"
  diffList={diffList}
  currentPage={0}
  onPageChange={(page) => setCurrentPage(page)}
  onDiffClick={(diff) => handleDiffClick(diff)}
/>
```

### 2. å®Œæ•´å¯¹æ¯”æ˜¾ç¤º

```tsx
import ComparisonDisplayWithPDF from '../components/ComparisonDisplayWithPDF';

<ComparisonDisplayWithPDF
  comparisonData={{
    comparison_id: "123",
    standard_pdf_url: "/api/documents/123/pdf",
    target_pdf_url: "/api/documents/456/pdf",
    diff_list: diffList,
    summary: summary,
    ai_review_enabled: true
  }}
  aiReviews={aiReviews}
  aiReviewStatus="completed"
  onRefreshAiReviews={handleRefresh}
/>
```

### 3. æ¨¡å¼åˆ‡æ¢

```tsx
const [usePDFViewer, setUsePDFViewer] = useState(true);

// åœ¨ComparisonDisplayWithPDFä¸­è‡ªåŠ¨æ”¯æŒæ¨¡å¼åˆ‡æ¢
// é€šè¿‡æµ®åŠ¨æŒ‰é’®æˆ–è®¾ç½®è¿›è¡Œåˆ‡æ¢
```

## APIæ¥å£

### åç«¯APIå˜æ›´

#### å¯¹æ¯”ç»“æœAPIå“åº”

```typescript
interface ComparisonResponse {
  comparison_id: string;
  // æ–°å¢PDF URLå­—æ®µ
  standard_pdf_url?: string;
  target_pdf_url?: string;
  page_count?: number;
  // ä¿ç•™å‘åå…¼å®¹
  standard_images: string[];
  target_images: string[];
  diff_list: DiffItem[];
  summary: Summary;
  ai_review_enabled?: boolean;
}
```

#### PDFæ–‡ä»¶ä¸‹è½½API

```http
GET /api/documents/{document_id}/pdf
```

è¿”å›åŸå§‹PDFæ–‡ä»¶ï¼Œæ”¯æŒæµè§ˆå™¨ç›´æ¥æ˜¾ç¤ºã€‚

### å‰ç«¯ç±»å‹å®šä¹‰

```typescript
interface DiffItem {
  element_id: string;
  status: 'ADD' | 'DELETE' | 'MODIFY' | 'MOVE';
  page_index: number;
  old_text?: string;
  new_text?: string;
  
  // åæ ‡ä¿¡æ¯
  diff: Array<Array<{
    text: string;
    page_index: number;
    char_polygons: number[][];
    // ... å…¶ä»–åæ ‡ä¿¡æ¯
  }>>;
}
```

## é…ç½®é€‰é¡¹

### PDF.jsé…ç½®

```typescript
// åœ¨PDFViewerç»„ä»¶ä¸­
pdfjsLib.GlobalWorkerOptions.workerSrc = 
  `//cdnjs.cloudflare.com/ajax/libs/pdf.js/${pdfjsLib.version}/pdf.worker.min.js`;
```

### é«˜äº®æ ·å¼é…ç½®

```typescript
const DIFF_STYLES = {
  ADD: { color: '#52c41a', opacity: 0.3 },
  DELETE: { color: '#ff4d4f', opacity: 0.3 },
  MODIFY: { color: '#faad14', opacity: 0.3 },
  MOVE: { color: '#1890ff', opacity: 0.3 }
};
```

## æ€§èƒ½ä¼˜åŒ–

### 1. è™šæ‹ŸåŒ–æ¸²æŸ“

```typescript
// åªæ¸²æŸ“å¯è§é¡µé¢çš„é«˜äº®
const pageDiffs = diffList.filter(diff => diff.page_index === currentPage);
```

### 2. Canvasä¼˜åŒ–

```typescript
// ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ¸²æŸ“
const renderHighlights = useCallback(() => {
  requestAnimationFrame(() => {
    // æ¸²æŸ“é€»è¾‘
  });
}, [dependencies]);
```

### 3. å†…å­˜ç®¡ç†

```typescript
// åŠæ—¶æ¸…ç†Canvasä¸Šä¸‹æ–‡
useEffect(() => {
  return () => {
    if (canvasRef.current) {
      const ctx = canvasRef.current.getContext('2d');
      ctx?.clearRect(0, 0, canvas.width, canvas.height);
    }
  };
}, []);
```

## æµè§ˆå™¨å…¼å®¹æ€§

### æ”¯æŒçš„æµè§ˆå™¨

- Chrome 60+
- Firefox 55+
- Safari 12+
- Edge 79+

### ä¾èµ–è¦æ±‚

- Canvas 2D APIæ”¯æŒ
- PDF.jså…¼å®¹æ€§
- ES6+æ”¯æŒ

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **PDFåŠ è½½å¤±è´¥**
   - æ£€æŸ¥PDFæ–‡ä»¶URLæ˜¯å¦æ­£ç¡®
   - ç¡®è®¤åç«¯PDFæ–‡ä»¶å­˜åœ¨
   - æ£€æŸ¥CORSè®¾ç½®

2. **é«˜äº®ä¸æ˜¾ç¤º**
   - æ£€æŸ¥å·®å¼‚æ•°æ®æ ¼å¼
   - ç¡®è®¤åæ ‡ä¿¡æ¯æ­£ç¡®
   - æ£€æŸ¥Canvaså°ºå¯¸è®¾ç½®

3. **æ€§èƒ½é—®é¢˜**
   - å‡å°‘åŒæ—¶æ¸²æŸ“çš„å·®å¼‚æ•°é‡
   - ä½¿ç”¨è™šæ‹ŸåŒ–æ¸²æŸ“
   - ä¼˜åŒ–Canvasç»˜åˆ¶é€»è¾‘

### è°ƒè¯•å·¥å…·

```typescript
// å¯ç”¨è°ƒè¯•æ—¥å¿—
console.log('[PDFViewer] PDFåŠ è½½æˆåŠŸ');
console.log('[HighlightRenderer] æ¸²æŸ“äº† X ä¸ªé«˜äº®');
```

## è¿ç§»æŒ‡å—

### ä»å›¾ç‰‡æ¨¡å¼è¿ç§»

1. **æ¸è¿›å¼è¿ç§»**
   ```typescript
   // æ”¯æŒä¸¤ç§æ¨¡å¼
   const usePDFViewer = featureFlags.enablePDFViewer;
   ```

2. **A/Bæµ‹è¯•**
   ```typescript
   // æ ¹æ®ç”¨æˆ·åˆ†ç»„é€‰æ‹©æ¨¡å¼
   const usePDFViewer = userGroup === 'pdf-viewer';
   ```

3. **å›æ»šæœºåˆ¶**
   ```typescript
   // ä¿ç•™å›¾ç‰‡æ¨¡å¼ä½œä¸ºé™çº§æ–¹æ¡ˆ
   if (pdfLoadError) {
     setUsePDFViewer(false);
   }
   ```

## æµ‹è¯•

### å•å…ƒæµ‹è¯•

```typescript
// æµ‹è¯•åæ ‡è½¬æ¢
test('PDFåæ ‡è½¬Canvasåæ ‡', () => {
  const result = CoordinateTransformer.pdfToCanvas(
    [100, 100, 200, 200],
    612, 792, 800, 600, 1.0
  );
  expect(result).toEqual([130, 126, 261, 253]);
});
```

### é›†æˆæµ‹è¯•

```typescript
// æµ‹è¯•PDFåŠ è½½å’Œé«˜äº®æ˜¾ç¤º
test('PDFé«˜äº®æ¸²æŸ“', async () => {
  render(<PDFHighlightViewer {...props} />);
  await waitFor(() => {
    expect(screen.getByText('å·®å¼‚è¢«ç‚¹å‡»')).toBeInTheDocument();
  });
});
```

## æœªæ¥è§„åˆ’

### çŸ­æœŸç›®æ ‡

- [ ] æ€§èƒ½ä¼˜åŒ–å’Œå†…å­˜ç®¡ç†
- [ ] æ›´å¤šäº¤äº’åŠŸèƒ½ï¼ˆç¼©æ”¾ã€æ—‹è½¬ï¼‰
- [ ] ç§»åŠ¨ç«¯é€‚é…

### é•¿æœŸç›®æ ‡

- [ ] 3Dé«˜äº®æ•ˆæœ
- [ ] å®æ—¶åä½œåŠŸèƒ½
- [ ] ç¦»çº¿æ”¯æŒ

---

*æœ€åæ›´æ–°: 2025-09-24*
